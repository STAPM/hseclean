<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Imputation of missing data • hseclean</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Imputation of missing data">
<meta property="og:description" content="hseclean">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">hseclean</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/alcohol_data.html">Process data on alcohol consumption</a>
    </li>
    <li>
      <a href="../articles/covariate_data.html">Process data on individual socio-demographic characteristics</a>
    </li>
    <li>
      <a href="../articles/missing_data.html">Imputation of missing data</a>
    </li>
    <li>
      <a href="../articles/scottish_data.html">Addition of Scottish data</a>
    </li>
    <li>
      <a href="../articles/smoking_data.html">Process data on tobacco smoking</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Imputation of missing data</h1>
            
      
      
      <div class="hidden name"><code>missing_data.Rmd</code></div>

    </div>

    
    
<div id="clean-tobacco-and-alcohol-data" class="section level1">
<h1 class="hasAnchor">
<a href="#clean-tobacco-and-alcohol-data" class="anchor"></a>Clean tobacco and alcohol data</h1>
<p>Do the setup for imputation by carrying out all the data cleaning functions.</p>
<p>There has already been some filling-in of missing data done by the cleaning functions described above.</p>
<ul>
<li>For 2015+, the <code><a href="../reference/clean_age.html">clean_age()</a></code> function has randomly assigned single years of age within each age category.<br>
</li>
<li>If someone is classified as a current smoker, is younger than 16 and has missing data on the time between waking and having their first cigarette, we assume that this time is one hour or more.<br>
</li>
<li>If someone is younger than age 16 and has missing data on their number of children (for survey years prior to 2015), we assume that they had no children.<br>
</li>
<li>If someone of any age is classified as a current smoker but has a missing value for the amount smoked, then we fill that missing value with the average amount smoked within a year, age, sex and IMD quintile subgroup.</li>
</ul>
<p>In the data preparation code above, we also have the option to filter the data to retain only complete cases for certain variables. Currently, we retain only records with full information on age, sex, smoking status and the survey design variables. We then multiply impute missing values for key socio-demographic variables.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r">
<span class="co">#root_dir &lt;- "X:/"</span>
<span class="no">root_dir</span> <span class="kw">&lt;-</span> <span class="fu">str_split_fixed</span>(<span class="fu">here</span>(), <span class="st">"ScHARR"</span>, <span class="fl">2</span>)[<span class="fl">1</span>]

<span class="co"># Wrap the individual cleaning functions in another function</span>
<span class="co"># that can then be applied to each year of HSE data</span>
<span class="no">cleandata</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">data</span>) {

  <span class="no">data</span> <span class="kw">%&lt;&gt;%</span>
    <span class="no">clean_age</span> <span class="kw">%&gt;%</span>
    <span class="no">clean_family</span> <span class="kw">%&gt;%</span>
    <span class="no">clean_demographic</span> <span class="kw">%&gt;%</span>
    <span class="no">clean_education</span> <span class="kw">%&gt;%</span>
    <span class="no">clean_economic_status</span> <span class="kw">%&gt;%</span>
    <span class="no">clean_income</span> <span class="kw">%&gt;%</span>
    <span class="no">clean_health_and_bio</span> <span class="kw">%&gt;%</span>
    <span class="no">smk_status</span> <span class="kw">%&gt;%</span>
    <span class="no">smk_former</span> <span class="kw">%&gt;%</span>
    <span class="no">smk_life_history</span> <span class="kw">%&gt;%</span>
    <span class="no">smk_amount</span> <span class="kw">%&gt;%</span>
    <span class="no">alc_drink_now_allages</span> <span class="kw">%&gt;%</span>
    <span class="no">alc_weekmean_adult</span> <span class="kw">%&gt;%</span>
    <span class="no">alc_sevenday_adult</span> <span class="kw">%&gt;%</span>
    <span class="no">alc_sevenday_child</span> <span class="kw">%&gt;%</span>

    <span class="fu"><a href="../reference/select_data.html">select_data</a></span>(
      <span class="kw">ages</span> <span class="kw">=</span> <span class="fl">12</span>:<span class="fl">89</span>,
      <span class="kw">years</span> <span class="kw">=</span> <span class="fl">2001</span>:<span class="fl">2017</span>,


      <span class="co"># The variables to retain</span>
      <span class="kw">keep_vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"wt_int"</span>, <span class="st">"psu"</span>, <span class="st">"cluster"</span>, <span class="st">"year"</span>, <span class="st">"quarter"</span>,
                    <span class="st">"age"</span>, <span class="st">"age_cat"</span>, <span class="st">"censor_age"</span>, <span class="st">"sex"</span>, <span class="st">"imd_quintile"</span>,

                    <span class="st">"degree"</span>, <span class="st">"relationship_status"</span>, <span class="st">"employ2cat"</span>, <span class="st">"social_grade"</span>, <span class="st">"kids"</span>, <span class="st">"income5cat"</span>,

                    <span class="st">"cig_smoker_status"</span>, <span class="st">"smk_start_age"</span>, <span class="st">"years_since_quit"</span>,
                    <span class="st">"cigs_per_day"</span>, <span class="st">"smoker_cat"</span>,

                    <span class="st">"drinks_now"</span>,
                    <span class="st">"drink_freq_7d"</span>, <span class="st">"n_days_drink"</span>, <span class="st">"peakday"</span>, <span class="st">"binge_cat"</span>,
                    <span class="st">"beer_units"</span>, <span class="st">"wine_units"</span>, <span class="st">"spirit_units"</span>, <span class="st">"rtd_units"</span>,
                    <span class="st">"weekmean"</span>,
                    <span class="st">"perc_spirit_units"</span>, <span class="st">"perc_wine_units"</span>, <span class="st">"perc_rtd_units"</span>, <span class="st">"perc_beer_units"</span>,
                    <span class="st">"drinker_cat"</span>,
                    <span class="st">"spirits_pref_cat"</span>, <span class="st">"wine_pref_cat"</span>, <span class="st">"rtd_pref_cat"</span>, <span class="st">"beer_pref_cat"</span>,
                    <span class="st">"total_units7_ch"</span>
      ),

      <span class="co"># The variables that must have complete cases</span>
      <span class="kw">complete_vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"age"</span>, <span class="st">"sex"</span>, <span class="st">"year"</span>, <span class="st">"quarter"</span>, <span class="st">"psu"</span>, <span class="st">"cluster"</span>)
    )

  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">data</span>)
}

<span class="co"># Read and clean each year of data and bind them together in one big dataset</span>
<span class="no">data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/combine_years.html">combine_years</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  <span class="fu">cleandata</span>(<span class="fu"><a href="../reference/read_2001.html">read_2001</a></span>(<span class="kw">root</span> <span class="kw">=</span> <span class="no">root_dir</span>)),
  <span class="fu">cleandata</span>(<span class="fu"><a href="../reference/read_2002.html">read_2002</a></span>(<span class="kw">root</span> <span class="kw">=</span> <span class="no">root_dir</span>)),
  <span class="fu">cleandata</span>(<span class="fu"><a href="../reference/read_2003.html">read_2003</a></span>(<span class="kw">root</span> <span class="kw">=</span> <span class="no">root_dir</span>)),
  <span class="fu">cleandata</span>(<span class="fu"><a href="../reference/read_2004.html">read_2004</a></span>(<span class="kw">root</span> <span class="kw">=</span> <span class="no">root_dir</span>)),
  <span class="fu">cleandata</span>(<span class="fu"><a href="../reference/read_2005.html">read_2005</a></span>(<span class="kw">root</span> <span class="kw">=</span> <span class="no">root_dir</span>)),
  <span class="fu">cleandata</span>(<span class="fu"><a href="../reference/read_2006.html">read_2006</a></span>(<span class="kw">root</span> <span class="kw">=</span> <span class="no">root_dir</span>)),
  <span class="fu">cleandata</span>(<span class="fu"><a href="../reference/read_2007.html">read_2007</a></span>(<span class="kw">root</span> <span class="kw">=</span> <span class="no">root_dir</span>)),
  <span class="fu">cleandata</span>(<span class="fu"><a href="../reference/read_2008.html">read_2008</a></span>(<span class="kw">root</span> <span class="kw">=</span> <span class="no">root_dir</span>)),
  <span class="fu">cleandata</span>(<span class="fu"><a href="../reference/read_2009.html">read_2009</a></span>(<span class="kw">root</span> <span class="kw">=</span> <span class="no">root_dir</span>)),
  <span class="fu">cleandata</span>(<span class="fu"><a href="../reference/read_2010.html">read_2010</a></span>(<span class="kw">root</span> <span class="kw">=</span> <span class="no">root_dir</span>)),
  <span class="fu">cleandata</span>(<span class="fu"><a href="../reference/read_2011.html">read_2011</a></span>(<span class="kw">root</span> <span class="kw">=</span> <span class="no">root_dir</span>)),
  <span class="fu">cleandata</span>(<span class="fu"><a href="../reference/read_2012.html">read_2012</a></span>(<span class="kw">root</span> <span class="kw">=</span> <span class="no">root_dir</span>)),
  <span class="fu">cleandata</span>(<span class="fu"><a href="../reference/read_2013.html">read_2013</a></span>(<span class="kw">root</span> <span class="kw">=</span> <span class="no">root_dir</span>)),
  <span class="fu">cleandata</span>(<span class="fu"><a href="../reference/read_2014.html">read_2014</a></span>(<span class="kw">root</span> <span class="kw">=</span> <span class="no">root_dir</span>)),
  <span class="fu">cleandata</span>(<span class="fu"><a href="../reference/read_2015.html">read_2015</a></span>(<span class="kw">root</span> <span class="kw">=</span> <span class="no">root_dir</span>)),
  <span class="fu">cleandata</span>(<span class="fu"><a href="../reference/read_2016.html">read_2016</a></span>(<span class="kw">root</span> <span class="kw">=</span> <span class="no">root_dir</span>)),
  <span class="fu">cleandata</span>(<span class="fu"><a href="../reference/read_2017.html">read_2017</a></span>(<span class="kw">root</span> <span class="kw">=</span> <span class="no">root_dir</span>))
))

<span class="co">##</span>
<span class="co"># Apply any tests</span>

<span class="co"># check that all current smokers have an amount smoked per data that is greater than zero</span>
<span class="kw pkg">testthat</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/testthat/man/equality-expectations.html">expect_equal</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">data</span>[<span class="no">cig_smoker_status</span> <span class="kw">==</span> <span class="st">"current"</span> <span class="kw">&amp;</span> <span class="no">cigs_per_day</span> <span class="kw">==</span> <span class="fl">0</span>]), <span class="fl">0</span>,
                       <span class="kw">info</span> <span class="kw">=</span> <span class="st">"some current smokers smoke 0 cigs per day"</span>)

<span class="co">##</span>
<span class="co"># Apply any filters</span>

<span class="co"># select only data with a coherent time since quit</span>
<span class="no">data</span>[ , <span class="no">years_since_quit</span> <span class="kw">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span>(<span class="no">years_since_quit</span>))]
<span class="no">data</span> <span class="kw">&lt;-</span> <span class="no">data</span>[!(<span class="no">cig_smoker_status</span> <span class="kw">==</span> <span class="st">"former"</span> <span class="kw">&amp;</span> <span class="no">years_since_quit</span> <span class="kw">&lt;</span> <span class="fl">1</span>)]
<span class="co">##</span>

<span class="co"># clean the survey weights</span>
<span class="no">data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/clean_surveyweights.html">clean_surveyweights</a></span>(<span class="no">data</span>)</pre></body></html></div>
</div>
<div id="multiple-imputation" class="section level1">
<h1 class="hasAnchor">
<a href="#multiple-imputation" class="anchor"></a>Multiple imputation</h1>
<p>To conduct our multiple imputation, we use the R package <code>mice</code> <span class="citation">(Stef van Buuren and Karin Groothuis-Oudshoorn <a href="#ref-Rmice">2011</a>)</span>. Since the process of running the multiple imputation can take a long time and consume a lot of RAM, it might be easiest to run on the <code>heta_study</code> virtual machine. There is a range of <code>mice</code> documentation and tutorials online that is worth getting into. In <code>hseclean</code>, multiple imputation is implemented by the <code><a href="../reference/impute_data_mice.html">impute_data_mice()</a></code> function, although this is currently written rather simply and could be checked and developed to include more optionality and potentially also diagnostic checks.</p>
<p><code>mice</code> basically fits a chained series of regression equations that predict the missing values of successive variables based on the existing relationships between those variables and selected other variables in the data. The current usage only imputes categorical variables, which could be one of three types: “logreg” - binary Logistic regression; “polr” - ordered Proportional odds model; “polyreg” - unordered Polytomous logistic regression.</p>
<p>In running the multiple imputation, the number of desired iterations of the imputed data is selected (I current generate five to keep the size of the resulting imputed data manageable), and the variables to either be predicted or to inform the prediction are selected. If a variable is just going to inform the prediction of the other variables but is not going to be predicted itself, then the model type is set to "“, otherwise to one of”logreg“,”polr" or “polyreg”.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="co"># First inspect variables</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">hse_data</span>$<span class="no">kids</span>, <span class="kw">useNA</span> <span class="kw">=</span> <span class="st">"ifany"</span>)

<span class="co"># Set a broader age category variable</span>
<span class="no">hse_data</span>[ , <span class="no">agegroup</span> <span class="kw">:=</span>
            <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"12-16"</span>, <span class="st">"16-17"</span>, <span class="st">"18-24"</span>, <span class="st">"25-34"</span>, <span class="st">"35-49"</span>, <span class="st">"50-64"</span>, <span class="st">"65-74"</span>, <span class="st">"75-89"</span>)[
              <span class="fu"><a href="https://rdrr.io/r/base/findInterval.html">findInterval</a></span>(<span class="no">age</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">10</span>, <span class="fl">16</span>, <span class="fl">18</span>, <span class="fl">25</span>, <span class="fl">35</span>, <span class="fl">50</span>, <span class="fl">65</span>, <span class="fl">75</span>, <span class="fl">1000</span>))]]

<span class="co"># Run the imputation (takes a long time)</span>
<span class="no">imp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/impute_data_mice.html">impute_data_mice</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">hse_data</span>,
                        <span class="kw">var_names</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"smk.state"</span>, <span class="st">"agegroup"</span>, <span class="st">"sex"</span>,
                                      <span class="st">"imd_quintile"</span>, <span class="st">"degree"</span>, <span class="st">"kids"</span>, <span class="st">"income5cat"</span>,
                                      <span class="st">"relationship_status"</span>, <span class="st">"employ2cat"</span>, <span class="st">"social_grade"</span>),
                        <span class="kw">var_methods</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>,
                                        <span class="st">"polr"</span>, <span class="st">"logreg"</span>, <span class="st">"polr"</span>, <span class="st">"polr"</span>,
                                        <span class="st">"polyreg"</span>, <span class="st">"logreg"</span>, <span class="st">"logreg"</span>),
                        <span class="kw">n_imputations</span> <span class="kw">=</span> <span class="fl">5</span>)

<span class="co"># imp$data is a single data.table containing all 5 imputed versions of the data</span>
<span class="no">hse_data_smoking</span> <span class="kw">&lt;-</span> <span class="fu">copy</span>(<span class="no">imp</span>$<span class="no">data</span>)</pre></body></html></div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-Rmice">
<p>Stef van Buuren and Karin Groothuis-Oudshoorn. 2011. “mice: Multivariate Imputation by Chained Equations in R.” <em>Journal of Statistical Software</em> 45 (3): 1–67. <a href="%7Bhttps://www.jstatsoft.org/v45/i03/%7D">{https://www.jstatsoft.org/v45/i03/}</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Duncan Gillespie, Laura Webster, Colin Angus, Alan Brennan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
