---
title: "Cigarette consumption"
author: "Duncan Gillespie"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Cigarette consumption}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
bibliography: consumption-refs.bib
header-includes:
  \usepackage{float}
  \usepackage{amsmath}
link-citations: yes
citation_package: natbib
biblio-style: vancouver
urlcolor: blue
---

```{r setup, include = FALSE, results = 'hide', warning = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.pos = 'H'
)

#library(readxl)
#library(data.table)
suppressPackageStartupMessages(library(ggplot2))
#library(cowplot)

#knitr::opts_knit$set(root.dir = "/Volumes/Shared/ScHARR/PR_STAPM/Code/R_packages/tobalcepi")
#knitr::opts_knit$set(root.dir = "X:/ScHARR/PR_STAPM/Code/R_packages/tobalcepi")

```

# Introduction
The Health Survey for England (HSE) is a series of annual surveys covering health and health-related behaviours. For the Sheffield Tobacco Policy Model (STPM) we use data from years 2001-2016. We use these data to inform the trends in smoking prevalence, the socio-demographic variation in smoking prevalence, and as inputs to a procedure that we use to infer the age-specific probabilities of smoking initiation and quitting (see the `smoke.trans` R package). Our upper age limit is 89 years, but otherwise we make use of all ages and incorporate all booster samples (e.g. in 2004 there was an ethnicity booster sample).  

One important thing to note is that the suppliers of the HSE data introduced tighter information governance rules in 2015, which meant they stopped providing variables that could be used to identify the age in single years of an individual, and also stopped providing information on number of children in the household. These variables can still be obtained, but only after applying for the secure-access version of the data, which also costs Â£1000 for each application. In our process of the standard-access version of the data, we use imputation methods to overcome the added restrictions.  

To support the processing of the HSE data, there is the `hseclean` R package, which contains a collection of functions to read, process and summarise the HSE data. The purpose of this vignette is to explain how we use the HSE data to inform the patterns of cigarette consumption, and to explain how the `hseclean` package supports this.  

# Survey design variables
The first thing to consider is the influence of survey sampling design, which is variable among years. The variables that describe the sampling structure are `cluster` and `PSU` (probabilistic sampling unit).  

In most years there are also survey weights, which are calculated after the survey data has been collected, that when applied are supposed to make the survey sample representative of the general population e.g. if a particular subgroup has been under-sampled, then it receives a higher survey weight. The definition and structure of the survey weights tends to vary between years, and is described in the dataset documentation. For example,
\begin{itemize}
\item For 2001, there were not survey weights for adults but there were for children (to correct for the sampling design that not all children in the household being surveyed).
\item For 2002, there were different weights for children, young adults (< 25 years) and older adults. These weights again were just to correct for the sampling design.
\item In 2003, non-response weighting was introduced to the HSE data for children and adults.
\item Thereafter, weights made the additional corrections for the various boost samples in each year. 
\end{itemize}  

`hseclean` contains separate functions for reading the survey data for each year, e.g. `read_2001()`, and a description of the survey weights has been added to the help files of those functions. Any processing or combining of survey weights is done in the functions that read each year of data. The function `clean_surveyweights()` assigns any missing weights the average weight for each year, and standardises the weights to sum to 1 within each year. The resulting survey weight variable for each year is `wt_int`.  

As far as I understand, the HSE survey weights are designed to make the survey sample representative of the population in terms of age and sex only. If this is correct, and socio-economic variables are not a factor in the design of the HSE survey weights, then this might mean that there is some bias in the estimates of overall smoking prevalence, particularly since smoking is highly socio-economically patterned. Something that is often raised in discussions is that the HSE estimates a slightly higher smoking prevalence that the Annual Population Survey (which is based on a much large sample linked to the Labour Force Survey). It is possible that this difference might be reconciled by a re-calculation of survey weights for each survey using the same method to adjust the sample to be representative of the socio-economic make-up of the general population. However, in our current work we use the survey weights supplied with the HSE data.  

Taking the survey design into account is important when estimating the mean and confidence intervals around summary statistics computed from the data i.e. it is not possible to accurately estimate sampling error without accounting for survey design. The `survey` R package [@Rsurvey] has a collection of functions that incorporate survey design into the calculation of summary statistics. The `survey` package is used by the function `prop_summary()` in `hseclean` to estimate the uncertainty around proportions calculated from a binary variable - `prop_summary()` was designed to simplify the process of estimating smoking prevalence from the HSE data, stratified by a specified set of variables.  

# Demographic and socio-economic variables
The `hseclean` package contains a range of functions to clean covariates in the data, which are explained more thoroughly in the vignette on covariates. Here we describe the important things to consider for the processing of smoking data.  

## Age
From 2015 onwards, the HSE no longer supplies age in single years (to prevent individual identification). For our modelling, we require age in single years, so we apply a method that randomly assigns an age in single years to individuals for whom we only have an age category. The age categories we work with are: 0-1, 2-4, 5-7, 8-10, 11-12, 13-15, 16-17, 18-19, 20-24, 25-29, 30-34, 35-39, 40-44, 45-49, 50-54, 55-59, 60-64, 65-69, 70-74, 75-79, 80-84, 85-89, 90+. These categories are the finest scale version of age that is available for years 2015+. We then select only individuals younger than 90 years for our modelling.  

This processing is done by the function `clean_age()` that calls the function `num_sim()` to simulate single years of age. For years 2015+, we also use `num_sim()` to convert the categorical variables for years since quitting smoking and years spent as a smoker to single years of age.  

## Economic status
The function `clean_economic_status()` creates a variety of variables to classify economic status.  

The issues around using occupation-based social classifications for social survey research are discussed by
Connelly et al. [-@Connelly2016a]. They advise using a range of alternative measures, but not creating new measures beyond what is already established.  

The classifications considered are:
\begin{itemize}
\item Employed / in paid work or not.
\item The \href{https://www.ons.gov.uk/methodology/classificationsandstandards/otherclassifications/thenationalstatisticssocioeconomicclassificationnssecrebasedonsoc2010}{NS-SEC measure} which was constructed to measure the employment relations and conditions of occupations (i.e. it classifies people based on their employment occupation). It is therefore not that good at classifying people who are not employed for various reasons.
\item The \href{https://humanrights.brightblue.org.uk/blog-1/2016/5/6/measuring-social-class}{NRS social grade system}. This measure is the one used in the Tobacco and Alcohol Toolkit studies, but is not reported in the Health Survey for England. We create this variable by recategorising the NS-SEC 8 level variable. This is important to facilitate the link of analysis to the Toolkit Study.
\item Manual vs. non-manual occupation. In the 2017 Tobacco control plan for England, there was a specific target to reduce the difference in rates of smoking between people classified with a manual or non-manual occupation. We create this variable from the 3 level NS-SEC classification by grouping Managerial and professional with intermediate occupations to give the non-manual group.
\item Economic status - retired / employed / unemployed.
\item Activity status for last week that adds more detail such as 'in education' and 'looking after home or family'.
\end{itemize}

## Education
The main education variable produced by the function `clean_education()` is a four category description of the age at which someone finished full-time education. The categories are:
\begin{itemize}
\item never went to school,
\item left at 15 years or younger,
\item left at 16-18,
\item left at 19 years or over.  
\end{itemize}

If someone was still in full time education at the time of the survey, then if they were younger than 18 years, we assumed they would leave at 16-18, and if they were older than 18 years, we assumed they would leave at 19 years or over.  

A further education variable is also produced - which indicates whether an individual reached a degree as their top qualification or not. Here a degree is defined as an "NVQ4/NVQ5/Degree or equiv".  

## Family
The function `clean_family()` processes the data on the number of children in the household and the relationship status of each respondent.

### Number of children in the household
Categorised into: 0, 1, 2, 3+. The problem with the Health Survey for England is that from 2015 onwards, the number of children in the household is not provided as this information could be identifiable (you can get it if you apply and pay for a secure dataset). Therefore, for years 2015+, the number of children in the household is completely missing and needs to be imputed (see the later section on multiple imputation).

### Relationship status
In previous versions of modelling (e.g. the alcohol binge model) relationship status has been described as married/not-married. Here, we include more detail by using:
\begin{itemize}
\item single
\item married, civil partnership or cohabiting
\item separated, divorced, widowed  
\end{itemize}

## Income
The function `clean_income()` processes the data on income.  

There are a few different options for classifying income - the need to have a measure that is consistent across years of the Health Survey for England has led us to use equivalised income quintiles only. Past SAPM modelling has used years of the Health Survey for England for which a continous variable for equivalised income was provided. From this, we calculated our own income groups. In later years, this continuous income variable is not available (except if we were to apply for a secure access version of the data).  

In the past a measure of in poverty / not in poverty has been used, where the poverty threshold is defined as 60% of the median income for any year. For years in which we only have income quintiles available, it is not possible to make an exact calculation of poverty. But it will coincide approximately with the lowest 2 income quintiles.  

It would also be possible from the Health Survey for England to classify people as being in receipt of benefits or not. This is not done currently, and would have to have some thought on how to deal with the changing definitions of benefits over time.

# Cigarette smoking variables
Questions about cigarette smoking have been asked of adults aged 16 and over as part of the HSE series since 1991. We use data from 2001 to the latest year available. We use data on children (12-15 years) and adults (16+ years). There is often a special section in the annual HSE report devoted to describing trends in cigarette smoking e.g. \href{https://files.digital.nhs.uk/publicationimport/pub22xxx/pub22610/hse2015-adult-smo.pdf}{HSE 2015}.  

## Cigarette smoking status
The function `smk_status()` categorises cigarette smoking into current, former and never regular cigarette smokers. If some smokes either regularly or ocassionally, then they are classified as a current regular cigarette smoker. People who used to smoke regularly or ocassionally are classified as former smokers, but people who have only tried a cigarette once or twice are classified as never smokers. We create this variable for children aged 8-15 years and adults aged >= 16 years. Ever-smokers are people who are either current or former smokers.  

## Former smoking
The function `smk_former()` cleans the data on the time since quitting and time spent as a regular smoker among former smokers. The main issue to be overcome is that in the HSE 2015+, time since quit and time spent as a smoker is provided in categories rather than single years. We simulate the single years by just picking a value at random within the time interval, using `num_sim()`. We also fill missing data: 

- For children 8-15 years, we assume that missing values for former smokers = 1 year.
- For adults, we fill missing values with the average value for each age, sex and IMD quintile subgroup.  

## Smoking life-histories

The function `smk_life_history()` cleans the ages that define when smokers started and stopped being regular cigarette smokers. For each individual smoker, the data recorded in the HSE implies a single age at which a smoker started to smoke and, if they stopped, an age at which they did so. This provides a simplified view of what might be a complicated life history of smoking, e.g. smoking to different frequencies or levels, or starting and stopping multiple times.  

Both the start age and stop age will have error in them e.g. due to uncertainty in respondent recall, and, for years 2015+, due to the reporting in categories of time intervals rather than single years, which we then impute introducing random error. Start age is likely to be biased towards earlier ages, because for adults with missing values we use the age first tried a cigarette, and for children the variable for start age does not necessarily mean the start of regular smoking, it is just the age at which they started to smoke.

We also create a variable for the age at which an individual was censored from our data sample - this is their age at the survey + 1 year.  

Any missing data is assigned the average start or stop age for each age, sex and IMD quintile.  

## Amount and type of cigarette smoked by current smokers
The function `smk_amount()` cleans the variables that describe how much, what and to what level of addiction people smoke. The main variable is the average number of cigarettes smoked per day. For adults this is calculated from questions about how many cigarettes are smoked typically on a weekday vs. a weekend. For children, this is based on asking how many cigarettes were smoked in the last week. Missing values are imputed as the average amount smoked for an age, sex and IMD quintile subgroup.  

We categorise cigarette preferences based on the answer to 'what is the main type of cigarette smoked'. In later years of the Health Survey for England, new questions are added that ask how many handrolled vs. machine rolled cigarettes are smoked on a weekday vs. a weekend. We currently don't use those questions because they were not asked in all years.  

We also categorise the amount smoked, and use information on the time from waking until smoking the first cigarette. This latter variable has a high level of missingness. Together these categorical variables allow calculation of \href{https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3307335/}{the heaviness of smoking index}.  

# Using hseclean

## Load and clean data

The data is stored in `X:/ScHARR/PR_Consumption_TA/Data/`. The following code will read, clean, filter and combine the data. 

```{r read data, eval = F}
# Install and load the package
install.packages("X:/ScHARR/PR_STAPM/Code/R_packages/hseclean_0.1.0.zip", repos = NULL)
library(hseclean)

# Write a bespoke function that does just the cleaning jobs required.
cleandata <- function(data) {
  data <- clean_surveyweights(data)
  data <- clean_age(data)
  data <- clean_demographic(data)
  data <- smk_status(data)
  data <- smk_former(data)
  data <- smk_life_history(data)
  data <- smk_amount(data)
  data <- select_data(
    data, ages = 12:89, years = 2001:2016,
    
    # The variables to retain
    keep_vars = c("wt_int", "psu", "cluster", "year", 
                  "age", "age_cat", "censor_age", "sex", "imd_quintile",
                  "cig_smoker_status", "smk_start_age", "years_since_quit"),
    
    # The variables that must have complete cases
    complete_vars = c("cig_smoker_status", "wt_int", "psu", "cluster", "year", "censor_age")
  )
return(data)
}

hse_data <- combine_years(list(
  cleandata(read_2014()), cleandata(read_2015()), cleandata(read_2016())
))

# clean the survey weights
hse_data <- clean_surveyweights(hse_data)

# change some variable names
setnames(hse_data, c("smk_start_age", "cig_smoker_status", "years_since_quit"),
         c("start_age", "smk.state", "time_since_quit"))

# check that all current smokers have an amount smoked per data that is greater than zero
testthat::expect_equal(nrow(hse_data[smk.state == "current" & cigs_per_day == 0]), 0,
                       info = "some current smokers smoke 0 cigs per day")

# select only data with a coherent time since quit
hse_data[ , time_since_quit := as.double(ceiling(time_since_quit))]
hse_data <- hse_data[!(smk.state == "former" & time_since_quit < 1)]
```

## Summarise data
Using `prop_summary()`, calculate the proportion of smokers, stratified by year, sex and quintiles of the Index of Multiple Deprivation.  

\bigskip

```{r ex2, eval = F}
prop_smokers <- prop_summary(
  data = hse_data,
  var_name = "smk.state",
  levels_1 = "current",
  levels_0 = c("former", "never"),
  strat_vars = c("year", "sex", "imd_quintile")
)

```

\bigskip

```{r smoking trends, eval = T, echo=F, warning=F, out.extra='', fig.width = 7, fig.height = 6, fig.cap = "Trends in the proportion of smokers."}

readRDS("X:/ScHARR/PR_STAPM/Code/R_packages/hseclean/vignettes/current_smoking_sex_imd_trend.rds")

```  

\newpage

## Impute data

### Imputation during data cleaning
There has already been some filling-in of missing data done by the cleaning functions described above.  

- For 2015+, the `clean_age()` function has randomly assigned single years of age within each age category.  
- If someone is classified as a current smoker, is younger than 16 and has missing data on the time between waking and having their first cigarette, we assume that this time is one hour or more.  
- If someone is younger than age 16 and has missing data on their number of children (for survey years prior to 2015), we assume that they had no children.  
- If someone of any age is classified as a current smoker but has a missing value for the amount smoked, then we fill that missing value with the average amount smoked within a year, age, sex and IMD quintile subgroup.

### Selecting complete cases
In the data preparation code above, we also have the option to filter the data to retain only complete cases for certain variables. Currently, we retain only records with full information on age, sex, smoking status and the survey design variables. We then multiply impute missing values for key socio-demographic variables.  

### Multiple imputation
To conduct our multiple imputation, we use the R package `mice` [@Rmice]. Since the process of running the multiple imputation can take a long time and consume a lot of RAM, it might be easiest to run on the `heta_study` virtual machine. There is a range of `mice` documentation and tutorials online that is worth getting into. In `hseclean`, multiple imputation is implemented by the `impute_data_mice()` function, although this is currently written rather simply and could be checked and developed to include more optionality and potentially also diagnostic checks.  

`mice` basically fits a chained series of regression equations that predict the missing values of successive variables based on the existing relationships between those variables and selected other variables in the data. The current usage only imputes categorical variables, which could be one of three types: "logreg" - binary Logistic regression; "polr" - ordered Proportional odds model; "polyreg" - unordered Polytomous logistic regression.  

In running the multiple imputation, the number of desired iterations of the imputed data is selected (I current generate five to keep the size of the resulting imputed data manageable), and the variables to either be predicted or to inform the prediction are selected. If a variable is just going to inform the prediction of the other variables but is not going to be predicted itself, then the model type is set to "", otherwise to one of "logreg", "polr" or "polyreg".  

\newpage

```{r mi example, eval = F}
# First inspect variables
table(hse_data$kids, useNA = "ifany")

# Set a broader age category variable
hse_data[ , agegroup := 
            c("12-16", "16-17", "18-24", "25-34", "35-49", "50-64", "65-74", "75-89")[
              findInterval(age, c(-10, 16, 18, 25, 35, 50, 65, 75, 1000))]]

# Run the imputation (takes a long time)
imp <- impute_data_mice(data = hse_data,
                        var_names = c("smk.state", "agegroup", "sex", 
                                      "imd_quintile", "degree", "kids", "income5cat",
                                      "relationship_status", "employ2cat", "social_grade"),
                        var_methods = c("", "", "", 
                                        "polr", "logreg", "polr", "polr",
                                        "polyreg", "logreg", "logreg"),
                        n_imputations = 5)

# imp$data is a single data.table containing all 5 imputed versions of the data
hse_data_smoking <- copy(imp$data)
```

# References
















































































































